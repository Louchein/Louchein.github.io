<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      #debug-info {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        z-index: 1000;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <!-- Debug Information Display -->
    <div id="debug-info">
      Target Status: Not Detected<br />
      Video/Model Status: Not Active
    </div>

    <a-scene
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band-example/band.mind; 
                     maxTrack: 2"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <!-- 3D Models -->
        <a-asset-item
          id="bearModel"
          src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band-example/bear/scene.gltf"
        ></a-asset-item>
        <a-asset-item
          id="raccoonModel"
          src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/band-example/raccoon/scene.gltf"
        ></a-asset-item>

        <!-- Videos for each target -->
        <video
          id="raccoon-video"
          src="raccoon-video.mp4"
          preload="auto"
          webkit-playsinline
          playsinline
          crossorigin="anonymous"
        ></video>
        <video
          id="bear-video"
          src="bear-video.mp4"
          preload="auto"
          webkit-playsinline
          playsinline
          crossorigin="anonymous"
        ></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Raccoon Target (Index 0) -->
      <a-entity mindar-image-target="targetIndex: 0">
        <!-- 3D Model -->
        <a-gltf-model
          id="raccoon-model"
          rotation="0 0 0"
          position="0 -0.25 0"
          scale="0.05 0.05 0.05"
          src="#raccoonModel"
          animation-mixer
        ></a-gltf-model>

        <!-- Video Plane -->
        <a-video
          id="raccoon-video-plane"
          src="#raccoon-video"
          width="1"
          height="0.5"
          position="0 0.5 -1"
          rotation="0 0 0"
        ></a-video>
      </a-entity>

      <!-- Bear Target (Index 1) -->
      <a-entity mindar-image-target="targetIndex: 1">
        <!-- 3D Model -->
        <a-gltf-model
          id="bear-model"
          rotation="0 0 0"
          position="0 -0.25 0"
          scale="0.05 0.05 0.05"
          src="#bearModel"
          animation-mixer
        ></a-gltf-model>

        <!-- Video Plane -->
        <a-video
          id="bear-video-plane"
          src="#bear-video"
          width="1"
          height="0.5"
          position="0 0.5 -1"
          rotation="0 0 0"
        ></a-video>
      </a-entity>
    </a-scene>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const sceneEl = document.querySelector("a-scene");
        const debugInfo = document.querySelector("#debug-info");

        // Video and model configurations
        const targets = [
          {
            videoEl: document.querySelector("#raccoon-video"),
            modelEl: document.querySelector("#raccoon-model"),
            videoPlaneEl: document.querySelector("#raccoon-video-plane"),
            lastPlaybackTime: 0,
            isTargetDetected: false,
          },
          {
            videoEl: document.querySelector("#bear-video"),
            modelEl: document.querySelector("#bear-model"),
            videoPlaneEl: document.querySelector("#bear-video-plane"),
            lastPlaybackTime: 0,
            isTargetDetected: false,
          },
        ];

        // Update debug information
        function updateDebugInfo() {
          const activeTargets = targets.filter((t) => t.isTargetDetected);
          debugInfo.innerHTML = activeTargets
            .map(
              (target, index) => `
                    Target ${index} Status: ${
                target.isTargetDetected ? "Detected" : "Not Detected"
              }<br>
                    Video Status: ${
                      !target.videoEl.paused ? "Playing" : "Paused"
                    }<br>
                    Last Playback Time: ${target.lastPlaybackTime.toFixed(2)}s
                `
            )
            .join("<br>");
        }

        // Handle target found for each target
        targets.forEach((target, index) => {
          sceneEl.addEventListener(`targetFound-${index}`, (event) => {
            target.isTargetDetected = true;

            // Show video plane
            target.videoPlaneEl.setAttribute("visible", true);

            // Resume video from last known time
            target.videoEl.currentTime = target.lastPlaybackTime;
            target.videoEl.play().catch(console.error);

            // Optional: pause animation mixer while video plays
            target.modelEl.setAttribute("animation-mixer", "play: false");

            updateDebugInfo();
          });

          sceneEl.addEventListener(`targetLost-${index}`, (event) => {
            // Store current video time
            target.lastPlaybackTime = target.videoEl.currentTime;

            // Pause video
            target.videoEl.pause();

            // Hide video plane
            target.videoPlaneEl.setAttribute("visible", false);

            // Resume model animation
            target.modelEl.setAttribute("animation-mixer", "play: true");

            target.isTargetDetected = false;
            updateDebugInfo();
          });

          // Continuous time tracking
          target.videoEl.addEventListener("timeupdate", () => {
            if (target.isTargetDetected) {
              target.lastPlaybackTime = target.videoEl.currentTime;
              updateDebugInfo();
            }
          });
        });

        // Initial setup to hide video planes
        targets.forEach((target) => {
          target.videoPlaneEl.setAttribute("visible", false);
        });
      });
    </script>
  </body>
</html>
